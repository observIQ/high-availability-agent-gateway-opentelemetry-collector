worker_processes auto;
events { worker_connections 1024; }

stream {
  upstream otlp_grpc {
    server gw1:4317 max_fails=3 fail_timeout=15s;
    server gw2:4317 max_fails=3 fail_timeout=15s;
    server gw3:4317 max_fails=3 fail_timeout=15s;
  }
  server {
    listen 4317;            # gRPC
    proxy_pass otlp_grpc;
    proxy_connect_timeout 1s;
    proxy_timeout 30s;
  }
}

http {
  upstream otlp_http {
    server gw1:4318 max_fails=3 fail_timeout=15s;
    server gw2:4318 max_fails=3 fail_timeout=15s;
    server gw3:4318 max_fails=3 fail_timeout=15s;
  }
  server {
    listen 4318;            # HTTP/JSON
    location / {
      proxy_pass http://otlp_http;
      proxy_next_upstream error timeout http_502 http_503 http_504;
    }
  }
}